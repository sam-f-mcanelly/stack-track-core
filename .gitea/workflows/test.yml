name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      # Override this value
      # https://github.com/actions/toolkit/blob/f31c2921c1228a97be08cdb38b919a83077354d9/packages/artifact/src/internal/shared/config.ts
      ACTIONS_RESULTS_URL: "http://gitea_server_1:8085"

    steps:
      - name: Test connection and add host mapping if necessary
        run: |
          echo "Testing initial connection to Gitea..."
          if curl -s --connect-timeout 10 --max-time 30 http://gitea_server_1:8085/api/v1/version; then
            echo "✅ Connection to gitea_server_1 successful - no host mapping needed"
          else
            echo "❌ Connection to gitea_server_1 failed - adding hostname mappings. Pulled from Docker"
            echo "10.21.0.12 gitea_server_1" | sudo tee -a /etc/hosts
            echo "10.21.0.12 umbrel.local" | sudo tee -a /etc/hosts
            echo "Added hostname mappings:"
            grep -E "(gitea_server_1|umbrel.local)" /etc/hosts

            echo "Testing connection again after adding mappings..."
            if curl -s --connect-timeout 10 --max-time 30 http://gitea_server_1:8085/api/v1/version; then
              echo "✅ Connection successful after adding hostname mappings"
            else
              echo "❌ Connection still failing after hostname mappings - check network/firewall"
              echo "Attempting connection to umbrel.local as fallback..."
              curl -s --connect-timeout 10 --max-time 30 http://umbrel.local:8085/api/v1/version || echo "❌ Fallback connection also failed"
            fi
          fi
      - name: Debug environment variables
        run: |
          echo "=== All Environment Variables ==="
          env | sort
          echo ""
          echo "=== Looking for umbrel/artifact related vars ==="
          env | grep -i -E "(umbrel|artifact|github|gitea|upload)"

      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'corretto'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Run tests
        run: ./gradlew test

      - name: Run integration tests
        run: ./gradlew integrationTest

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: build/reports/